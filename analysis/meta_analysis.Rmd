---
title: "Running the meta-analysis"
output: 
  workflowr::wflow_html:
    code_folding: hide 
editor_options:
  chunk_output_type: console
  code_folding: hide
---

```{r include=FALSE}
pretty3 <- function(x) {
  formatC(x, format = "f", digits = 3)
}
```


Load packages, the meta-analysis data, and a helper function.

```{r message=F}
library(tidyverse)
library(metafor)
library(DT)
library(ggh4x)
library(kableExtra)


# function to make the searchable, exportable HTML table
my_data_table <- function(df){

  num_cols <- names(df)[sapply(df, is.numeric)]
  num_cols <- num_cols[num_cols != "Generations"]

  datatable(
    df, rownames = FALSE,
    autoHideNavigation = TRUE,
    extensions = c("Scroller", "Buttons"),
    options = list(
      autoWidth = TRUE,
      dom = 'Bfrtip',
      deferRender = TRUE,
      scrollX = TRUE,
      scrollY = 1000,
      scrollCollapse = TRUE,
      buttons = list(
        'pageLength', 'colvis', 'csv',
        list(
          extend = 'pdf',
          pageSize = 'A4',
          orientation = 'landscape',
          filename = 'Trait_data'
        )
      ),
      pageLength = 100
    )
  ) %>%
    formatRound(
      columns = num_cols,
      digits = 3
    ) 
}


# Load up the meta-analysis data:
meta_analysis_data <- list.files("effect_sizes/", full.names = T) %>% 
  lapply(read_csv, show_col_types = FALSE) %>% 
  bind_rows() %>% 
  left_join(read_csv("input_data/study_metadata.csv"), by = join_by(Study)) %>% 
  mutate(year = str_extract(Short_name, "[:digit:]+")) %>% 
  arrange(year) %>% 
  mutate(Sex = "Both",
         Sex = replace(Sex, str_detect(Trait, "Male"), "Male"),
         Sex = replace(Sex, str_detect(Trait, "Female"), "Female"))
```

## Data collected for the meta-analysis

```{r include = F}
# hidden code chunk that counts up the sample sizes
n_expts <- meta_analysis_data$Origin_of_lines %>% unique() %>% length()
n_pubs <- meta_analysis_data$Study %>% unique() %>% length()
n_effects <- nrow(meta_analysis_data)
```


This table is searchable and can be exported as a file. You can also hide columns to help read it. There are `r n_effects` effect sizes from `r n_expts` independent experimental evolution projects, which were published across `r n_pubs` journal articles.

```{r}
meta_analysis_data %>% 
  select(-year, -Short_name) %>% 
  my_data_table()
```


## Meta-analysis without moderators

This meta-analysis can be used to calculate the grand mean effect size. It's a mixed effects meta-analysis with the random effects structure `~ 1 | Origin_of_lines/Study`. This means we fit a random intercept for `Origin_of_lines`, a variable which gives the name of the study that first created the experimental evolution lines being measured. We also fit a random intercept for `Study` nested within `Origin_of_lines`, where `Study` is a variable giving the name of the study doing the measuring (which is often the same study, but not always, since some studies re-measured lines that were created in an earlier study). 

```{r}
meta_analysis <- rma.mv(
  yi = Estimate,
  V = Var,
  random = ~ 1 | Origin_of_lines/Study,
  data = meta_analysis_data,
  method = "REML"
)

summary(meta_analysis)
```

The above results table shows that the grand mean effect size is `r pretty3(as.numeric(meta_analysis$b))`, with a standard error of `r pretty3(meta_analysis$se)` and 95% CIs of `r pretty3(meta_analysis$ci.lb)` to `r pretty3(meta_analysis$ci.ub)`.

## Testing for effects of moderators

Here, I use AICc model selection to compare 7 competing meta-analysis models, which fit `Generations`, `Sex`, `Experiment_type`, a combination of 2 or all of these, or the intercept-only null model. `Generations` gives the number of generations of selection at the time the focal trait was measured, `Sex` gives the sex of the individuals expressing the trait (male, female, or both sexes), and `Experiment_type` is either "Sex-specific autosome(s)", "Sex-specific X", or "Sex-specific relaxed selection" (as described by the point colours in Figure 1).

The top model includes the moderator `Generations`, and it is ahead of second-best model (which also includes `Sex`) by much more than 2 AICc, suggesting that `Generations` explains substantial variation in the data but the other moderators do not.

```{r}
fit_ma <- function(formula){
  
  scaled_meta_analysis_data <-
    meta_analysis_data %>% 
    mutate(Generations = as.numeric(scale(Generations)))
  
  if(formula == "Intercept only"){
    return(meta_analysis)
  }
  
  rma.mv(
    yi = Estimate,
    V = Var,
    mods = as.formula(formula),
    random = ~ 1 | Origin_of_lines/Short_name,
    data = scaled_meta_analysis_data,
    method = "REML"
  )
}

fit_all <- function(formulae){
  meta <- lapply(formulae, fit_ma)
  get_p <- function(ma) as.numeric(ma$p)
  get_logLik <- function(ma) as.numeric(logLik(ma))
  get_AICc <- function(ma) as.numeric(AIC(ma, correct = T))
  
  data.frame(
    Model = formulae,
    k     = sapply(meta, get_p),
    logLik = sapply(meta, get_logLik),
    AICc   = sapply(meta, get_AICc)) %>% 
    arrange(AICc) %>% 
    mutate(Model = str_remove_all(Model, "~ "),
           delta_AICc = round(AICc - AICc[1], 2),
           delta_AICc = c(" ", delta_AICc[2:length(delta_AICc)]))
}

fit_all(c("~ Generations + Sex + Experiment_type1",
          "~ Generations + Sex",
          "~ Sex + Experiment_type1",
          "~ Generations",
          "~ Sex",
          "~ Experiment_type1",
          "Intercept only")) %>% 
  kable() %>% 
  kable_styling(full_width = FALSE)
```

```{r include=FALSE}
mean_gen <- round(mean(meta_analysis_data$Generations),1)
```



Below are the results of the top model containing moderators, showing the significant negative effect of the moderator `Generations` on effect size (note: `Generations` was scaled to have mean 0, SD 1, prior to analysis). This is a counter-intuitive result since we might expect greater effects after more generations of selection, but it is not very informative since `Generations` is confounded with other factors (e.g. species, type of experimental design, type of trait being measured, and whether I used the raw data or summary statistics to calculate effect size). The grand mean effect size (predicted here for the average value of `Generations`, which is `r mean_gen`) is much the same after adjusting for the effect of `Generations`.

```{r}
fit_ma("~ Generations")
```


## Forest plot of effect sizes (Figure 1)

```{r fig.height = 8.2, fig.width=7}
plot_data <- meta_analysis_data %>% 
  select(Origin_of_lines, Short_name, 
         Experiment_type1, Experiment_type2, Trait, Estimate, 
         Lower_95_CI, 
         Upper_95_CI) 

plot_data$Trait[plot_data$Trait == "Male fitness" & 
                  plot_data$Short_name == "Abbott et al. (2013)"] <- "Male fitness (2013)"
plot_data$Trait[plot_data$Trait == "Male fitness" & 
                  plot_data$Short_name == "Abbott et al. (2020)"] <- "Male fitness (2020)"

mean_effect <- tibble(
    Origin_of_lines = " ", Short_name = "**Mean effect size**", 
         Experiment_type1 = "  ", Trait = " ", 
    Estimate = as.numeric(meta_analysis$b), 
         Lower_95_CI = as.numeric(meta_analysis$ci.lb), 
    Upper_95_CI  = as.numeric(meta_analysis$ci.ub)
  )

plot_data <- plot_data %>% 
  group_by(Origin_of_lines) %>% 
  mutate(Short_name = paste0(unique(Short_name), collapse = ";\n")) %>% 
  bind_rows(mean_effect) %>% ungroup() %>% 
  arrange((Experiment_type2))

plot_data$Short_name[plot_data$Short_name == "Rice (1996);\nRice (1998)"] <- "**Male-limited haplotypes**<br>Rice (1996, 1998)"

plot_data$Short_name[plot_data$Short_name == "Prasad et al. (2007);\nBedhomme et al. (2008);\nAbbott et al. (2010);\nBedhomme et al. (2011);\nJiang et al. (2011)"] <- "**Male-limited haplotypes**<br>Prasad et al. (2007)<br>Bedhomme et al. (2008, 2011)<br>Jiang et al. (2011)"
  
plot_data$Short_name[plot_data$Short_name == "Thyagarajan et al. (2025)"] <- "**Male-limited haplotypes**<br>Thyagarajan et al. (2025)"

plot_data$Short_name[plot_data$Short_name == "Rice (1992)"] <- "**Female-limited region** (Rice 1992)"


plot_data$Short_name[plot_data$Short_name == "Grieshop et al. (2025);\nMelo-Gavin et al. (2025)"] <- "**Male-limited autosome**<br>Grieshop et al. (2025), Melo-Gavin et al. (2025)"

plot_data$Short_name[plot_data$Short_name == "Nordén et al. (2020)"] <- "**Reciprocal sex-limited markers**<br>Nordén et al. (2020)"

plot_data$Short_name[plot_data$Short_name == "Abbott et al. (2013);\nAbbott et al. (2020)"] <- "**Male-limited X**<br>Abbott et al. (2013, 2020)"

plot_data$Short_name[plot_data$Short_name == "Lund-Hansen et al. (2020);\nManat et al. (2021)"] <- "**Female-limited X**<br>Lund-Hansen et al. (2020)<br>Manat et al. (2021)"

plot_data$Short_name[plot_data$Short_name == "Radwan et al. (2004)"] <- "**Relaxed selection on females**<br>Radwan et al. (2004)"

plot_data$Short_name[plot_data$Short_name == "Morrow et al. (2008)"] <- "**Relaxed selection on both sexes**<br>Morrow et al. (2004)"


plot_data$Short_name <- str_remove_all(plot_data$Short_name, " et al[.]")
plot_data$Short_name <- str_remove_all(plot_data$Short_name, ";")

levs <- plot_data$Short_name %>% unique()

plot_data <- plot_data %>% 
  mutate(Short_name = factor(Short_name, levs)) 

bands <- plot_data %>%
  arrange(Estimate) %>%
  group_by(Short_name) %>%
  mutate(y = row_number()) %>%
  summarise(
    ymin = min(y) - 0.5,
    ymax = max(y) + 0.5,
    stripe = cur_group_id() %% 2,
    .groups = "drop"
  )

# order the traits within studies by effect size
plot_data <- plot_data %>% 
  mutate(Short_name = factor(Short_name, levs)) %>% 
  arrange(Estimate) %>% 
  mutate(Trait_study = factor(paste(Trait, Short_name, sep = "~"), 
                              unique(paste(Trait, Short_name, sep = "~"))))

mean_effect <- plot_data %>% 
  filter(Short_name == "**Mean effect size**")

plot_data %>% 
  mutate(Experiment_type1 = factor(
    Experiment_type1, levels = c("Sex-specific autosome(s)",
                                 "Sex-specific X",
                                 "Sex-specific relaxed selection", "  "))) %>% 
  ggplot(aes(y = Trait_study, x = Estimate, colour = Experiment_type1)) +
  # scale_color_brewer(palette = "Set1", direction = -1) + 
  scale_colour_manual(values = c("steelblue", "tomato", "forestgreen", NA)) +
  geom_rect(
    data = bands,
    aes(
      xmin = -Inf,
      xmax = Inf,
      ymin = -Inf,
      ymax = Inf,
      fill = factor(stripe)),
    alpha = 0.3,
    inherit.aes = FALSE) +
  geom_vline(xintercept = 0, linetype = 2, colour = "grey10") +
  geom_errorbar(aes(xmin = Lower_95_CI, 
                    xmax = Upper_95_CI)) +
  geom_point() + 
  
  geom_errorbar(data = mean_effect, aes(xmin = Lower_95_CI, 
                                        xmax = Upper_95_CI), colour = "black") +
  geom_point(data = mean_effect, colour = "black") + 
  
  scale_y_discrete(labels = function(x) sub("~.*$", "", x)) + 
  facet_grid2(rows = vars(Short_name),
              scales = "free_y",
              space = "free_y") +
  theme_minimal()+
  theme(legend.position = "top",
        strip.text.y = ggtext::element_markdown(angle = 0, hjust = 0, size = 7),
        axis.text.y = element_text(size = 7),
        strip.background = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.ticks.x = element_line(colour = "grey20", size = 0.2),
        panel.border = element_rect(colour = "grey20", size = 0.2),
        panel.clip = "off",
        # strip.text.y = element_text(angle = 0, hjust=0),
        panel.spacing.y=unit(0, "pt"))+ 
  labs(x = "Effect size (Cohen's d) \u00B1 95% CIs", 
       y = NULL,
       colour = NULL) +  
  coord_cartesian(clip = "off") + 

  scale_fill_manual(values = c("0" = "grey80", 
                               "1" = "grey50")) +
  guides(fill = "none")
  # scale_fill_manual(values = c("0" = rgb(1, 98, 71, maxColorValue=255), 
  #                              "1" = rgb(144, 165, 210, maxColorValue=255))) +
```

**Figure 1**: Forest plot showing the estimated effect sizes (Cohen's _d_ \(\pm \) 95% CIs). The y-axis indicates which trait was measured, and the coloured bands group effect sizes that come from the same set of experimental evolution lines (which are covered in one or more publications, named on the right). Positive effect sizes indicate evolutionary change in the direction predicted under IaSC, while negative effects indicate evolution in the opposite direction. Point colour differentiates between studies that manipulated inheritance vs selection. The grand mean effect size, shown at the bottom, is significantly positive. 

## Plotting effect of moderator `Generations`

On the right of x-axis (high generation number), this result is driven by a couple of studies, Lund-Hansen et al. (2020) and Manat et al. (2021), which both relate to the same set of experimental evolution lines, and which both focus on female-limited evolution of X chromosomes (uniquely in the full dataset). I also calculated the effect sizes from the raw data for these studies, avoiding issues with falsely inflating them. to the left of the x-axis (short generation number), the trend is driven by a couple of older studies I calculated the effect sizes from summary statistics, possibly inflating them. 

Therefore, I don't feel there is good evidence for a true negative effect of `Generations`, and this result instead reflects confounding.

```{r}
library(ggrepel)
meta_analysis_data %>% 
  ggplot(aes(Generations, Estimate)) + 
  geom_point() + 
  geom_text_repel(aes(label = Short_name), size = 2, max.overlaps = 1000)
  
```

